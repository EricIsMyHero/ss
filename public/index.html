// server.js
// Qura≈üdƒ±rma: npm init -y
//           npm i express node-fetch
// √áalƒ±≈üdƒ±rma: TELEGRAM_BOT_TOKEN=xxx TELEGRAM_CHAT_ID=yyy node server.js

const express = require('express');
const fs = require('fs');
const fetch = require('node-fetch');

const app = express();
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

const TELEGRAM_BOT_TOKEN = process.env.TELEGRAM_BOT_TOKEN; // bot token
const TELEGRAM_CHAT_ID = process.env.TELEGRAM_CHAT_ID;     // s…ôn…ô g…ôl…ôn chat id

if (!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID) {
  console.warn('X∆èB∆èRDARLIK: TELEGRAM_BOT_TOKEN v…ô TELEGRAM_CHAT_ID …ôtraf m√ºhit d…ôyi≈ü…ônl…ôri t…ôyin edilm…ôyib.');
}

// Helper: real client IP (X-Forwarded-For d…ôst…ôyi)
function getClientIp(req) {
  const xff = req.headers['x-forwarded-for'];
  if (xff) return xff.split(',')[0].trim();
  // req.socket.remoteAddress ola bil…ôr ::ffff:1.2.3.4 formatƒ±nda
  return req.socket.remoteAddress || req.ip || 'unknown';
}

app.post('/collect', async (req, res) => {
  try {
    const ip = getClientIp(req);
    const ua = req.headers['user-agent'] || '';
    const time = new Date().toISOString();
    const page = req.body.path || req.body.page || req.headers.referer || req.originalUrl;

    // 1) qeyd…ô al (opsional)
    const log = { ip, ua, time, page };
    fs.appendFile('ips.log', JSON.stringify(log) + '\n', () => {});

    // 2) Telegram mesajƒ± g√∂nd…ôr (opt)
    if (TELEGRAM_BOT_TOKEN && TELEGRAM_CHAT_ID) {
      const text = `üì£ Zarafat ziyar…ôt√ßi!\nIP: ${ip}\nVaxt: ${time}\nUA: ${ua}\nS…ôhif…ô: ${page}`;
      const url = `https://api.telegram.org/bot${8408687620:AAEy2vYnaR8Be9kpbjoKpCTUAXMMHvvd4AE}/sendMessage`;
      try {
        await fetch(url, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ chat_id: 1689497109, text })
        });
      } catch (e) {
        console.error('Telegram g√∂nd…ôrm…ô x…ôtasƒ±:', e);
      }
    }

    // 3) frontend-…ô ip-ni qaytar
    res.json({ ok: true, ip });
  } catch (err) {
    console.error(err);
    res.status(500).json({ ok: false });
  }
});

// Statik fayllarƒ± servis et (index.html v…ô s. eyni qovluqda olduqda)
app.use(express.static('public'));

const PORT = process.env.PORT || 3000;
app.listen(PORT, () => console.log(`Server ${PORT}-da i≈ü…ô d√º≈üd√º`)); 
